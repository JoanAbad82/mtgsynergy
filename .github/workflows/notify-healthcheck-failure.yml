name: Notify on Healthcheck Failure

on:
  workflow_run:
    workflows: ["Production Healthcheck"]
    types: [completed]

permissions:
  contents: read
  issues: write

concurrency:
  group: notify-healthcheck-failure
  cancel-in-progress: true

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = "ðŸš¨ Healthcheck failing";
            const runUrl = context.payload.workflow_run.html_url;
            const runId  = context.payload.workflow_run.id;
            const when   = context.payload.workflow_run.updated_at;

            const body =
              `Healthcheck workflow failed.\n\n` +
              `- Run: ${runUrl}\n` +
              `- Run ID: ${runId}\n` +
              `- When: ${when}\n\n` +
              `Action: Investigate Cloudflare Pages deploy / routing / cache.\n`;

            // Find existing open issue with the same title (avoid spam)
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              });
              core.info(`Updated existing issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ["ops", "healthcheck"]
              });
              core.info(`Created issue #${created.data.number}`);
            }
